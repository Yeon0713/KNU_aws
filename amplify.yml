version: 1
applications:
  - appRoot: knu_flutter_app
    frontend:
      phases:
        preBuild:
          commands:
            # Force cache invalidation and Flutter setup
            - |
              echo "=== 캐시 무효화 및 Flutter 설치 시작 ==="
              echo "빌드 시간: $(date)"
              
              # 기존 Flutter 디렉토리 완전 삭제 (캐시 무효화)
              rm -rf flutter
              rm -rf ~/.pub-cache
              
              # Flutter 새로 설치
              echo "Flutter 새로 설치 중..."
              wget -O flutter.tar.xz https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.16.0-stable.tar.xz
              tar xf flutter.tar.xz
              rm flutter.tar.xz
              echo "Flutter 설치 완료"
              
              # PATH 설정 및 Flutter 검증
              export PATH="$PATH:$PWD/flutter/bin"
              echo "PATH 설정: $PATH"
              
              # Flutter 버전 확인
              flutter --version
              flutter doctor -v
              
              # 의존성 설치
              echo "Flutter 의존성 설치 중..."
              flutter pub get
              echo "=== preBuild 단계 완료 ==="
        build:
          commands:
            # Build with absolute Flutter path
            - |
              echo "=== 강제 새로운 빌드 시작 ==="
              echo "빌드 시간: $(date)"
              
              # Flutter 절대 경로 설정
              FLUTTER_ROOT="/codebuild/output/src$(echo $CODEBUILD_SRC_DIR | cut -d'/' -f5-)/flutter"
              FLUTTER_BIN="$FLUTTER_ROOT/bin/flutter"
              
              echo "Flutter 경로: $FLUTTER_BIN"
              
              # Flutter 존재 확인
              if [ -f "$FLUTTER_BIN" ]; then
                echo "✅ Flutter 바이너리 발견"
                $FLUTTER_BIN --version
              else
                echo "❌ Flutter 바이너리를 찾을 수 없음"
                echo "현재 작업 디렉토리: $(pwd)"
                echo "상위 디렉토리 확인:"
                ls -la ../
                echo "Flutter 디렉토리 찾기:"
                find .. -name "flutter" -type d 2>/dev/null || echo "Flutter 디렉토리 없음"
                exit 1
              fi
              
              # 기존 빌드 결과 삭제
              rm -rf build
              
              # pubspec.yaml 확인
              echo "pubspec.yaml 내용 (처음 10줄):"
              head -10 pubspec.yaml
              
              # 강제 클린 빌드
              echo "Flutter 클린 실행..."
              $FLUTTER_BIN clean
              
              echo "Flutter 웹 빌드 실행..."
              $FLUTTER_BIN build web --web-renderer html --release --verbose
              
              # 빌드 결과 확인
              echo "=== 빌드 결과 확인 ==="
              if [ -d "build/web" ]; then
                echo "✅ build/web 디렉토리 생성됨"
                ls -la build/web/
                if [ -f "build/web/index.html" ]; then
                  echo "✅ index.html 파일 존재함"
                  echo "파일 크기: $(wc -c < build/web/index.html) bytes"
                else
                  echo "❌ index.html 파일이 없음"
                  exit 1
                fi
              else
                echo "❌ build/web 디렉토리가 생성되지 않음"
                echo "현재 디렉토리 내용:"
                ls -la
                exit 1
              fi
              
              echo "=== 빌드 성공적으로 완료 ==="
      artifacts:
        baseDirectory: build/web
        files:
          - '**/*'
      cache:
        paths: []  # 캐시 비활성화